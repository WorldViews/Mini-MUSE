<html>
<head>
<title>Yolo Watcher Test Page</title>
</head>
<body>
<script src="js/socket.io-1.4.5.js"></script>
<script src="js/MUSEControl.js"></script>
<script src="js/jquery-3.1.1.min.js"></script>
<script>
console.log("Getting MUSEControl");
var mc = new MUSEControl();
console.log("MUSEControl mc", mc);

VIDEO_IDS = [];
VIDEO_IDS[1] = 'vLN43P2Icpw';
VIDEO_IDS[2] = 'uUkcD9jD5xY';
VIDEO_IDS[3] = 'YfSUXAi80w8';


function setVideo(num)
{
    var videoId = VIDEO_IDS[num];
    console.log("setting videoId to", videoId);
    mc.setVideoId(videoId);
    return 0;
}

PAGES = [];
PAGES[1] = 'http://fxpal.com';
PAGES[2] = 'http://xerox.com';
PAGES[3] = 'http://palweb';

function setPage(num)
{
    var url = PAGES[num];
    console.log("setting page URL  to", url);
    mc.setDisplayURL(url);
    return 0;
}

function getJSON(url, handler, errFun)
{
    console.log("getJSON: "+url);
    $.ajax({
        url: url,
        dataType: 'text',
        success: function(str) {
            var data;
            try {
                data = JSON.parse(str);
            }
            catch (err) {
                console.log("err: "+err);
                alert("Error in json for: "+url+"\n"+err);
                errFun();
                return;
            }
            handler(data);
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.log("Failed to get JSON for "+url);
            if (errFun)
               errFun();
        }
    });
}

var lastVidId = null;
function handleYoloData(yoloObj)
{
    console.log("handleYoloData");
    var objs = yoloObj.objects;
    var sawPerson = false;
    objs.forEach(obj => {
        var label = obj.label;
        if (label == 'person')
            sawPerson = true;
        console.log(label, obj);
    });
    var vidId = sawPerson ? 1 : 2;
    if (vidId != lastVidId)
        setVideo(vidId);
    lastVidId = vidId;
}

function fetchYoloInfo() {
   url = "http://192.168.16.39:5000/detect.json";
   getJSON(url, obj => {
       //console.log("got:", obj);
       handleYoloData(obj);
       fetchYoloInfo();
   });
}

$(document).ready(() => {
    console.log("**** Document is ready ****");
    fetchYoloInfo();
});

</script>

<h1>MUSE Controls Test Page</h1>
<h3>Youtube Player</h3>
<input type="button" value="Video 1" onclick="setVideo(1)"><br>
<input type="button" value="Video 2" onclick="setVideo(2)"><br>
<input type="button" value="Video 3" onclick="setVideo(3)"><br>

<h3>Webpage Player</h3>
<input type="button" value="Page 1" onclick="setPage(1)"><br>
<input type="button" value="Page 2" onclick="setPage(2)"><br>
<input type="button" value="Page 3" onclick="setPage(3)"><br>
</body>
</html>
